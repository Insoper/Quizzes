<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Instruktur - Kuis Interaktif</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f8fc;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      background-color: white;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #007bff; }
    select, button, input {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button.primary { background-color: #28a745; color: white; border: none; }
    button.primary:hover { background-color: #218838; }
    button.info { background-color: #007bff; color: white; border: none; margin-top: 10px; }
    button.info:hover { background-color: #0069d9; }
    button.danger { background-color: #dc3545; color: white; border: none; margin-top: 10px; }
    button.danger:hover { background-color: #c82333; }
    .status { margin-top: 15px; font-weight: bold; text-align: center; }
    .login-box {
      max-width: 400px;
      margin: 80px auto;
      background-color: white;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .soal-preview { margin-top: 20px; }
    .judul-kategori { font-weight: bold; color: #007bff; margin-bottom: 4px; }
    .waktu-info { font-size: 14px; color: #555; margin: 4px 0 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div id="loginForm" class="login-box">
  <h2>Login Instruktur</h2>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Masuk</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="mainContent" class="container hidden">
  <h2>üìã Panel Instruktur</h2>
  <label for="kategoriSelect">Pilih Kategori Soal:</label>
  <select id="kategoriSelect"><option value="">-- Pilih Kategori --</option></select>

  <label for="durasiSelect">Pilih Durasi Soal:</label>
  <select id="durasiSelect">
    <option value="1">1 Jam</option>
    <option value="2">2 Jam</option>
    <option value="3">3 Jam</option>
    <option value="24">24 Jam</option>
  </select>

  <input type="text" id="kodeKelas" placeholder="Kode Kelas (misal: 001)" maxlength="3" />
  <button class="primary" onclick="tampilkanKategori()">Tampilkan ke siswa</button>

  <div id="status" class="status"></div>
  <div id="preview" class="soal-preview"></div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwgH4bAdBOyGxy5p6yxXNBBYPBvOjfrhV5nkmqRGA8WBtBqWRXS5YsiyIEtr2SjmMoDIQ/exec";
  const validUser = "Insoper_UT";
  const validPass = "dediKASI";
  let semuaSoal = [];

  window.onload = async function () {
    const saved = JSON.parse(localStorage.getItem("loginData"));
    if (saved && (Date.now() - saved.waktuLogin < 12 * 60 * 60 * 1000)) {
      document.getElementById("username").value = saved.user;
      document.getElementById("password").value = saved.pass;
      login(true);
    }
  };

  function login(auto = false) {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    if (user === validUser && pass === validPass) {
      localStorage.setItem("loginData", JSON.stringify({ user, pass, waktuLogin: Date.now() }));
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      fetchSoal();
      loadSoalAktif();
    } else if (!auto) {
      document.getElementById("loginError").innerText = "Username atau password salah.";
    }
  }

  async function fetchSoal() {
    try {
      const res = await fetch(GAS_URL);
      const data = await res.json();
      semuaSoal = data;
      isiDropdownKategori(data);
    } catch (err) {
      alert("‚ùå Gagal mengambil soal: " + err);
    }
  }

  function isiDropdownKategori(data) {
    const set = new Set();
    data.forEach(row => row.Kategori && set.add(row.Kategori));
    const dropdown = document.getElementById("kategoriSelect");
    set.forEach(kat => {
      const opt = document.createElement("option");
      opt.value = kat;
      opt.textContent = kat;
      dropdown.appendChild(opt);
    });
  }

  async function tampilkanKategori() {
    const kategori = document.getElementById("kategoriSelect").value;
    const durasi = parseInt(document.getElementById("durasiSelect").value);
    const kelas = document.getElementById("kodeKelas").value.trim();

    if (!kategori || !/^\d{3}$/.test(kelas)) {
      alert("Pilih kategori & isi kode kelas (3 digit).");
      return;
    }

    const now = new Date();
    const akhir = new Date(now.getTime() + durasi * 60 * 60 * 1000);
    const soalKategori = semuaSoal.filter(s => s.Kategori === kategori);

    const data = {
      tipe: "soalaktif",
      KodeKelas: kelas,
      Kategori: kategori,
      Soal: soalKategori,
      WaktuMulai: now.toISOString(),
      WaktuAkhir: akhir.toISOString()
    };

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      document.getElementById("status").innerText = `‚úÖ Soal kategori "${kategori}" untuk kelas ${kelas} ditampilkan.`;
      tampilkanPreview(kategori, now, akhir, kelas);
    } catch (err) {
      alert("‚ùå Gagal kirim soal aktif: " + err);
    }
  }

  function tampilkanPreview(kategori, mulai, akhir, kelas) {
    const preview = document.getElementById("preview");
    const waktuMulai = new Date(mulai).toLocaleString();
    const waktuAkhir = new Date(akhir).toLocaleString();
    const id = `kategori-${kelas}-${kategori.replace(/\s+/g, '')}`;
    if (document.getElementById(id)) return; // Cegah duplikat

    let html = `<div class="soal-kategori" id="${id}">`;
    html += `<div class="judul-kategori">üìò <b>Kategori:</b> ${kategori} | <b>Kelas:</b> ${kelas}</div>`;
    html += `<div class="waktu-info">üïí Mulai: ${waktuMulai} | Selesai: ${waktuAkhir}</div>`;
    html += `<button class="danger" onclick="hapusSoal('${id}')">Tutup Soal</button>`;
    html += "</div><hr>";
    preview.innerHTML += html;
  }

  function hapusSoal(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }

  async function loadSoalAktif() {
    try {
      const res = await fetch(GAS_URL + "?tipe=soalaktif");
      const data = await res.json();
      const now = new Date();

      data.forEach(row => {
        const waktuAkhir = new Date(row.WaktuAkhir);
        if (now <= waktuAkhir) {
          tampilkanPreview(row.Kategori, row.WaktuMulai, row.WaktuAkhir, row.KodeKelas);
        }
      });
    } catch (err) {
      console.error("‚ùå Gagal ambil soal aktif:", err);
    }
  }
</script>
</body>
</html>
